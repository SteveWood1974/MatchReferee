<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Match Referee</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/site.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sansation:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100 sansation-regular">
    <!-- Navigation -->
    <nav id="navbar" class="navbar navbar-expand-lg brand-grey text-white sticky-top d-flex justify-content-center align-items-center " style="min-height: 60px;">
    </nav>
    <!-- Hero Banner -->
    <section class="bg-football text-white d-flex align-items-center">
        <div class="container text-center">
            <h2 class="display-4 fw-bold mb-4">Welcome to Match Referee</h2>
            <p class="lead mb-5">Sign in to manage your matches.</p>
        </div>
    </section>
    <!-- Sign In Form -->
    <section class="py-5">
        <div class="d-flex justify-content-center align-items-center">
            <div class="card shadow p-4" style="max-width: 420px; width: 100%;">
                <h2 class="text-center mb-4">Sign In</h2>
                <form id="signinForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" placeholder="Email" class="form-control" required autocomplete="username">
                    </div>
                    <div class="mb-3 position-relative">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="password" placeholder="Password" class="form-control" required autocomplete="current-password">
                            <button type="button" class="btn btn-outline-secondary" id="togglePassword" aria-label="Toggle password visibility">
                                <i class="fas fa-eye" id="eyeIcon"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" id="signinBtn" class="btn btn-success w-100 mb-3" disabled>
                        Sign In
                    </button>
                    <div class="text-center mb-3">
                        <a href="#" class="text-muted small" id="forgotPassword">Forgot password?</a>
                    </div>
                    <p id="error" class="alert alert-danger mt-3 d-none" role="alert"></p>
                    <p id="success" class="alert alert-success mt-3 d-none" role="alert"></p>
                </form>

                <!-- Forgot Password Reset Form (hidden by default) -->
                <div id="resetSection" class="mt-4 d-none">
                    <h5 class="text-center mb-3">Reset Your Password</h5>
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Email address</label>
                        <input type="email" id="resetEmail" placeholder="Enter your email" class="form-control" autocomplete="email">
                    </div>
                    <button type="button" id="sendResetBtn" class="btn btn-primary w-100 mb-2">Send Reset Email</button>
                    <button type="button" id="cancelReset" class="btn btn-outline-secondary w-100">Back to Sign In</button>
                </div>
            </div>
        </div>
    </section>
    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-auto">
        <div class="container text-center">
            <p>© 2026 Match Referee. All rights reserved.</p>
        </div>
    </footer>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/common.js"></script>
    <script>
        // Prevent form submission / page refresh
        document.getElementById('signinForm').addEventListener('submit', function (e) {
            e.preventDefault(); // ← This stops the refresh
            document.getElementById('signinBtn').click();
        });
    </script>
    <script type="module">
        import { signInWithEmailAndPassword, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

        // Load navbar
        window.loadNavbar();
        window.loadFooter();

        // Initialize Firebase + enable sign-in button
        window.initFirebasePage(() => {
            const signinBtn = document.getElementById('signinBtn');
            signinBtn.disabled = false;
            signinBtn.textContent = 'Sign In';
            signinBtn.onclick = signin;
        });

        async function signin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('error');
            try {
                if (errorEl) errorEl.classList.add('d-none');
                const userCredential = await signInWithEmailAndPassword(
                    window.firebaseAuth,
                    email,
                    password
                );
                const user = userCredential.user;
                let redirectPath = '/secure/profile'; // default
                try {
                    const token = await user.getIdToken();
                    const resp = await fetch('/api/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (resp.ok) {
                        const profile = await resp.json();
                        if (!profile.ProfileCompleted) {
                            redirectPath = '/secure/profile';
                        }
                    }
                } catch (profileErr) {
                    console.warn('Could not check profile completion:', profileErr);
                }
                location.href = redirectPath;
            } catch (e) {
                let message = 'Login failed. Please check your email and password.';
                if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    message = 'Invalid email or password.';
                } else if (e.code === 'auth/user-disabled') {
                    message = 'This account has been disabled.';
                } else if (e.code === 'auth/too-many-requests') {
                    message = 'Too many failed attempts. Please try again later.';
                } else if (e.code === 'auth/invalid-credential') {
                    message = 'Invalid credentials.';
                } else if (e.message) {
                    message = e.message;
                }
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('d-none');
                } else {
                    console.error('Login error:', e);
                    alert(message);
                }
            }
        }

        // ───────────────────────────────────────────────
        // Forgot Password / Reset Email Logic
        // ───────────────────────────────────────────────
        const forgotLink = document.getElementById('forgotPassword');
        const resetSection = document.getElementById('resetSection');
        const sendResetBtn = document.getElementById('sendResetBtn');
        const cancelReset = document.getElementById('cancelReset');
        const resetEmailInput = document.getElementById('resetEmail');
        const successEl = document.getElementById('success');
        const errorEl = document.getElementById('error');

        // Show reset form
        forgotLink?.addEventListener('click', (e) => {
            e.preventDefault();
            resetSection.classList.remove('d-none');
            resetEmailInput.focus();
            // Pre-fill with sign-in email if present
            if (document.getElementById('email').value.trim()) {
                resetEmailInput.value = document.getElementById('email').value.trim();
            }
        });

        // Hide reset form
        cancelReset?.addEventListener('click', () => {
            resetSection.classList.add('d-none');
            successEl.classList.add('d-none');
            errorEl.classList.add('d-none');
        });

        // Send reset email
        sendResetBtn?.addEventListener('click', async () => {
            const email = resetEmailInput.value.trim();
            if (!email) {
                errorEl.textContent = 'Please enter your email address.';
                errorEl.classList.remove('d-none');
                return;
            }

            sendResetBtn.disabled = true;
            sendResetBtn.textContent = 'Sending...';
            errorEl.classList.add('d-none');
            successEl.classList.add('d-none');

            try {
                await sendPasswordResetEmail(window.firebaseAuth, email);
                successEl.textContent = 'If your email was recognised, we have now sent a password reset email. Please check your inbox (and spam/junk folder).';
                successEl.classList.remove('d-none');

                // Clear the email field after success
                document.getElementById('email').value = resetEmailInput.value;
                resetEmailInput.value = '';
                
                // Auto-hide reset form after a short delay
                setTimeout(() => {
                    resetSection.classList.add('d-none');
                }, 6000);
            } catch (e) {
                let message = 'Failed to send reset email. Please try again.';
                if (e.code === 'auth/user-not-found') {
                    message = 'No account found with that email address.';
                } else if (e.code === 'auth/invalid-email') {
                    message = 'Please enter a valid email address.';
                } else if (e.code === 'auth/too-many-requests') {
                    message = 'Too many requests. Please wait a few minutes and try again.';
                } else if (e.message) {
                    message = e.message;
                }
                errorEl.textContent = message;
                errorEl.classList.remove('d-none');
            } finally {
                sendResetBtn.disabled = false;
                sendResetBtn.textContent = 'Send Reset Email';
            }
        });
    </script>
</body>
</html>