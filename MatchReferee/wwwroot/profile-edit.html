<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Match Referee</title>
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="/css/site.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sansation:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body class="bg-light d-flex flex-column min-vh-100 sansation-regular">
    <main class="flex-grow-1">
        <!-- Navigation -->
        <nav id="navbar" class="navbar navbar-expand-lg brand-grey text-white sticky-top d-flex justify-content-center align-items-center" style="min-height: 60px;"></nav>

        <!-- Hero Section -->
        <section class="hero-section bg-football text-white d-flex align-items-center" style="min-height: 350px;">
            <div class="container text-center">
                <h1 class="display-4 fw-bold mb-4 sansation-bold">Your Profile</h1>
                <p class="lead mb-5">Update your details below. This information is shared across all roles.</p>
            </div>
        </section>

        <!-- Loading & Error -->
        <div id="loading" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading your profile...</p>
        </div>

        <div id="error-message" class="alert alert-danger mx-auto my-4 d-none" style="max-width: 800px;">
            An error occurred loading your profile. Please try again or sign in.
        </div>

        <!-- Main Profile Edit Content -->
        <section id="secure-content" class="py-5 d-none">
            <div class="container">
                <form id="profileForm">
                    <!-- Panel 1: Basic Info -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Basic Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="fullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="fullName" name="fullName" required placeholder="Your full name">
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" required readonly>
                                    <small class="form-text text-muted">Email cannot be changed here. Contact support if needed.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel 2: Role & Affiliation -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Role & Affiliation</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="role" class="form-label">Primary Role <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="Referee">Referee</option>
                                        <option value="Coach">Coach</option>
                                        <option value="Club">Club / Team</option>
                                        <option value="League">League / Organisation</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="affiliationNumber" class="form-label">Affiliation / Registration Number</label>
                                    <input type="text" class="form-control" id="affiliationNumber" name="affiliationNumber"
                                           placeholder="e.g. FA Referee No. 1234567 or Club ID">
                                    <small class="form-text text-muted">Required for referees – helps with verification</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel: Referee Details (conditional) -->
                    <div class="card shadow mb-4 d-none" id="refereeFields">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Referee Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="refereeLevel" class="form-label">Referee Level/Grade</label>
                                    <input type="text" class="form-control" id="refereeLevel" name="refereeLevel"
                                           placeholder="e.g. Level 5, Supply, National List">
                                </div>
                                <div class="col-md-6">
                                    <label for="yearsExperience" class="form-label">Years of Experience</label>
                                    <input type="number" class="form-control" id="yearsExperience" name="yearsExperience" min="0" max="60">
                                </div>
                                <div class="col-12">
                                    <label for="regions" class="form-label">Regions/Areas Willing to Cover</label>
                                    <input type="text" class="form-control" id="regions" name="regions"
                                           placeholder="e.g. Greater London, South East, Midlands">
                                    <small class="form-text text-muted">Comma-separated list if multiple</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel 3: Contact & Location -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Contact & Location</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="e.g. 07700 900123">
                                </div>
                                <div class="col-md-6">
                                    <label for="postcode" class="form-label">Postcode / Area</label>
                                    <input type="text" class="form-control" id="postcode" name="postcode" placeholder="e.g. SW1A 1AA or London Area">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel 4: Personal Details -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Personal Details (Optional)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="ageRange" class="form-label">Age Range</label>
                                    <select class="form-select" id="ageRange" name="ageRange">
                                        <option value="">Prefer not to say</option>
                                        <option value="14-15">14-15</option>
                                        <option value="16-17">16-17</option>
                                        <option value="18-24">18–24</option>
                                        <option value="25-34">25–34</option>
                                        <option value="35-44">35–44</option>
                                        <option value="45-54">45–54</option>
                                        <option value="55-64">55–64</option>
                                        <option value="65+">65+</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-select" id="gender" name="gender">
                                        <option value="">Prefer not to say</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Non-binary">Non-binary</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="pronouns" class="form-label">Preferred Pronouns</label>
                                    <input type="text" class="form-control" id="pronouns" name="pronouns" placeholder="e.g. he/him, she/her, they/them">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel 5: About -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">About You</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="bio" class="form-label">Short Bio</label>
                                <textarea class="form-control" id="bio" name="bio" rows="4" maxlength="500" placeholder="Tell others a bit about yourself... (max 500 characters)"></textarea>
                                <small class="form-text text-muted">Shown in public directories and search results.</small>
                            </div>
                            <div class="mb-3">
                                <label for="profilePhoto" class="form-label">Profile Photo</label>
                                <input type="file" class="form-control" id="profilePhoto" name="profilePhoto" accept="image/*">
                                <small class="form-text text-muted">Optional. PNG, JPG or GIF. Max 2MB recommended.</small>
                                <div class="mt-3">
                                    <img id="previewPhoto" src="/img/default-user.png" alt="Current profile photo" style="max-width: 180px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel 6: Account Info (Read-only) -->
                    <div class="card shadow mb-5 bg-light">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">Account Information</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Subscription Status</dt>
                                <dd class="col-sm-8" id="subscriptionStatus">Loading...</dd>
                                <dt class="col-sm-4">Account Created</dt>
                                <dd class="col-sm-8" id="createdDate">Loading...</dd>
                            </dl>
                        </div>
                    </div>

                    <!-- Global Save Button -->
                    <div class="text-center mb-5">
                        <button type="submit" id="saveProfileBtn" class="btn btn-primary btn-lg px-5">
                            <i class="fas fa-save me-2"></i> Save Profile
                        </button>
                        <p id="formFeedback" class="mt-3 alert d-none"></p>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="/js/common.js"></script>

    <!-- Profile Load & Save Logic -->
    <script type="module">
        // Wait for Firebase ready
        window.addEventListener('firebaseReady', async () => {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error-message');
            const contentEl = document.getElementById('secure-content');
            const form = document.getElementById('profileForm');
            const saveBtn = document.getElementById('saveProfileBtn');
            const feedback = document.getElementById('formFeedback');
            const refereePanel = document.getElementById('refereeFields');

            // Auth check & profile load
            firebaseAuth.onAuthStateChanged(async (user) => {
                if (!user) {
                    location.href = '/signin';
                    return;
                }

                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');

                try {
                    const token = await user.getIdToken();
                    const resp = await fetch('/api/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!resp.ok) throw new Error('Failed to load profile');

                    const profile = await resp.json();

                    // Populate form fields
                    document.getElementById('fullName').value = profile.name || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = profile.phoneNumber || '';
                    document.getElementById('postcode').value = profile.postcode || '';
                    document.getElementById('ageRange').value = profile.ageRange || '';
                    document.getElementById('gender').value = profile.gender || '';
                    document.getElementById('pronouns').value = profile.pronouns || '';
                    document.getElementById('bio').value = profile.bio || '';
                    document.getElementById('role').value = profile.role || 'Referee';
                    document.getElementById('affiliationNumber').value = profile.affiliationNumber || '';

                    // Referee-specific
                    document.getElementById('refereeLevel').value = profile.refereeLevel || '';
                    document.getElementById('yearsExperience').value = profile.yearsExperience || '';
                    document.getElementById('regions').value = profile.regions ? profile.regions.join(', ') : '';

                    // Show referee panel if applicable
                    if (profile.role === 'Referee') {
                        refereePanel.classList.remove('d-none');
                    }

                    // Profile photo preview
                    if (profile.profilePhotoUrl) {
                        document.getElementById('previewPhoto').src = profile.profilePhotoUrl;
                    }

                    // Read-only fields
                    document.getElementById('subscriptionStatus').textContent = profile.subscriptionActive ? 'Active' : 'Inactive';
                    document.getElementById('createdDate').textContent = profile.createdAt
                        ? new Date(profile.createdAt).toLocaleDateString('en-GB')
                        : 'Unknown';

                } catch (err) {
                    errorEl.textContent = err.message || 'Could not load profile.';
                    errorEl.classList.remove('d-none');
                }
            });

            // Show/hide referee fields when role changes
            document.getElementById('role').addEventListener('change', (e) => {
                if (e.target.value === 'Referee') {
                    refereePanel.classList.remove('d-none');
                } else {
                    refereePanel.classList.add('d-none');
                }
            });

            // Profile photo preview
            document.getElementById('profilePhoto')?.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        document.getElementById('previewPhoto').src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Form submit
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Saving...';
                feedback.classList.add('d-none');

                try {
                    const formData = new FormData(form);
                    const token = await firebaseAuth.currentUser.getIdToken();

                    // If there's no file, we could send JSON instead – but FormData handles both
                    const resp = await fetch('/api/profile', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // Note: Do NOT set Content-Type when using FormData with file upload
                        },
                        body: formData
                    });

                    if (!resp.ok) {
                        const errText = await resp.text();
                        throw new Error(errText || 'Failed to save profile');
                    }

                    feedback.textContent = 'Profile saved successfully!';
                    feedback.classList.remove('d-none', 'alert-danger');
                    feedback.classList.add('alert-success');

                } catch (err) {
                    feedback.textContent = err.message || 'Failed to save profile.';
                    feedback.classList.remove('d-none', 'alert-success');
                    feedback.classList.add('alert-danger');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i> Save Profile';
                }
            });
        });

        // Trigger if Firebase already ready
        if (window.firebaseAuth) {
            window.dispatchEvent(new Event('firebaseReady'));
        }
    </script>
</body>
</html>